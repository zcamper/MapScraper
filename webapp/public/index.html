<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MapScraper - Lead Generation Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f7fa; color: #333; }

        /* Header */
        .header { background: #1a73e8; color: #fff; padding: 16px 24px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 20px; font-weight: 600; }
        .header .user-info { display: flex; align-items: center; gap: 16px; font-size: 14px; }
        .header .credits-badge { background: rgba(255,255,255,0.2); padding: 6px 14px; border-radius: 20px; font-weight: 500; }
        .header button { background: rgba(255,255,255,0.15); color: #fff; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; }
        .header button:hover { background: rgba(255,255,255,0.25); }

        /* Layout */
        .container { max-width: 1200px; margin: 0 auto; padding: 24px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .full-width { grid-column: 1 / -1; }

        /* Cards */
        .card { background: #fff; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 24px; }
        .card h2 { font-size: 16px; font-weight: 600; margin-bottom: 16px; color: #1a73e8; }

        /* Auth */
        .auth-container { max-width: 400px; margin: 80px auto; }
        .auth-container h1 { text-align: center; color: #1a73e8; margin-bottom: 8px; font-size: 28px; }
        .auth-container p { text-align: center; color: #666; margin-bottom: 24px; }
        .auth-tabs { display: flex; margin-bottom: 20px; }
        .auth-tabs button { flex: 1; padding: 12px; background: #f0f0f0; border: none; cursor: pointer; font-size: 14px; font-weight: 500; }
        .auth-tabs button.active { background: #1a73e8; color: #fff; }
        .auth-tabs button:first-child { border-radius: 6px 0 0 6px; }
        .auth-tabs button:last-child { border-radius: 0 6px 6px 0; }

        /* Forms */
        .form-group { margin-bottom: 14px; }
        .form-group label { display: block; font-size: 13px; font-weight: 500; margin-bottom: 4px; color: #555; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #1a73e8; box-shadow: 0 0 0 2px rgba(26,115,232,0.15); }
        .form-row { display: flex; gap: 12px; }
        .form-row .form-group { flex: 1; }
        .checkbox-group { display: flex; align-items: center; gap: 8px; }
        .checkbox-group input { width: auto; }

        /* Buttons */
        .btn { display: inline-block; padding: 10px 20px; border: none; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; transition: background 0.2s; }
        .btn-primary { background: #1a73e8; color: #fff; }
        .btn-primary:hover { background: #1557b0; }
        .btn-primary:disabled { background: #93bff5; cursor: not-allowed; }
        .btn-sm { padding: 6px 14px; font-size: 12px; }
        .btn-outline { background: transparent; border: 1px solid #ddd; color: #555; }
        .btn-outline:hover { background: #f5f5f5; }
        .btn-danger { background: #dc3545; color: #fff; }
        .btn-success { background: #28a745; color: #fff; }

        /* Stats */
        .stats { display: flex; gap: 16px; margin-bottom: 20px; }
        .stat-box { flex: 1; background: #f8f9fa; padding: 16px; border-radius: 8px; text-align: center; }
        .stat-box .value { font-size: 24px; font-weight: 700; color: #1a73e8; }
        .stat-box .label { font-size: 12px; color: #888; margin-top: 4px; }

        /* Tables */
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th, td { text-align: left; padding: 10px 12px; border-bottom: 1px solid #eee; }
        th { font-weight: 600; color: #666; font-size: 12px; text-transform: uppercase; }

        /* Status badges */
        .badge { padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
        .badge-queued { background: #fff3cd; color: #856404; }
        .badge-running { background: #cce5ff; color: #004085; }
        .badge-completed { background: #d4edda; color: #155724; }
        .badge-failed { background: #f8d7da; color: #721c24; }

        /* Export buttons */
        .export-btns { display: flex; gap: 8px; flex-wrap: wrap; }

        /* Alerts */
        .alert { padding: 12px 16px; border-radius: 6px; margin-bottom: 16px; font-size: 13px; }
        .alert-error { background: #f8d7da; color: #721c24; }
        .alert-success { background: #d4edda; color: #155724; }
        .alert-info { background: #cce5ff; color: #004085; }

        /* API key display */
        .api-key-display { font-family: monospace; background: #f5f5f5; padding: 8px 12px; border-radius: 4px; font-size: 13px; word-break: break-all; }

        /* Tabs for dashboard sections */
        .nav-tabs { display: flex; gap: 4px; border-bottom: 2px solid #e0e0e0; margin-bottom: 24px; }
        .nav-tabs button { padding: 10px 20px; background: none; border: none; border-bottom: 2px solid transparent; margin-bottom: -2px; cursor: pointer; font-size: 14px; font-weight: 500; color: #666; }
        .nav-tabs button.active { color: #1a73e8; border-bottom-color: #1a73e8; }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .hidden { display: none !important; }
        .monospace { font-family: monospace; }
    </style>
</head>
<body>

<!-- Auth Screen -->
<div id="auth-screen" class="auth-container">
    <h1>MapScraper</h1>
    <p>Lead Generation Dashboard</p>
    <div class="card">
        <div class="auth-tabs">
            <button class="active" onclick="showAuthTab('login')">Login</button>
            <button onclick="showAuthTab('register')">Register</button>
        </div>
        <div id="auth-error"></div>

        <form id="login-form" onsubmit="handleLogin(event)">
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="login-email" required placeholder="you@example.com">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="login-password" required placeholder="Your password">
            </div>
            <button type="submit" class="btn btn-primary" style="width:100%">Login</button>
        </form>

        <form id="register-form" class="hidden" onsubmit="handleRegister(event)">
            <div class="form-group">
                <label>Name</label>
                <input type="text" id="register-name" placeholder="Your name">
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="register-email" required placeholder="you@example.com">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="register-password" required minlength="6" placeholder="Min 6 characters">
            </div>
            <button type="submit" class="btn btn-primary" style="width:100%">Register (100 Free Credits)</button>
        </form>
    </div>
</div>

<!-- Dashboard -->
<div id="dashboard-screen" class="hidden">
    <div class="header">
        <h1>MapScraper</h1>
        <div class="user-info">
            <span id="user-email"></span>
            <span class="credits-badge" id="credits-display">0 credits</span>
            <button onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="container">
        <div class="nav-tabs">
            <button class="active" onclick="showTab('scrape')">New Scrape</button>
            <button onclick="showTab('jobs')">My Jobs</button>
            <button onclick="showTab('credits')">Credits</button>
            <button onclick="showTab('settings')">Settings</button>
        </div>

        <!-- Scrape Tab -->
        <div id="tab-scrape" class="tab-content active">
            <div class="grid">
                <div class="card">
                    <h2>Search Configuration</h2>
                    <div id="scrape-error"></div>
                    <form onsubmit="startScrape(event)">
                        <div class="form-group">
                            <label>Search Terms (comma-separated)</label>
                            <input type="text" id="search-terms" placeholder="restaurant, cafe, hotel" required>
                        </div>
                        <div class="form-group">
                            <label>Location</label>
                            <input type="text" id="search-location" placeholder="New York, USA" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Max Results</label>
                                <input type="number" id="search-max" value="50" min="1" max="500">
                            </div>
                            <div class="form-group">
                                <label>Language</label>
                                <select id="search-lang">
                                    <option value="en">English</option>
                                    <option value="es">Spanish</option>
                                    <option value="fr">French</option>
                                    <option value="de">German</option>
                                    <option value="it">Italian</option>
                                    <option value="pt">Portuguese</option>
                                    <option value="ja">Japanese</option>
                                    <option value="ko">Korean</option>
                                    <option value="zh-CN">Chinese</option>
                                    <option value="ar">Arabic</option>
                                    <option value="ru">Russian</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Min Rating</label>
                                <input type="number" id="search-min-rating" step="0.5" min="0" max="5" placeholder="Any">
                            </div>
                            <div class="form-group">
                                <label>Reviews per Place</label>
                                <input type="number" id="search-reviews-limit" value="5" min="0" max="100">
                            </div>
                        </div>
                        <div class="form-row" style="margin-bottom:16px">
                            <div class="checkbox-group">
                                <input type="checkbox" id="search-reviews" checked>
                                <label for="search-reviews">Scrape Reviews</label>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="search-hours" checked>
                                <label for="search-hours">Opening Hours</label>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary" id="scrape-btn" style="width:100%">
                            Start Scraping
                        </button>
                    </form>
                </div>
                <div class="card">
                    <h2>Quick Stats</h2>
                    <div class="stats">
                        <div class="stat-box">
                            <div class="value" id="stat-credits">0</div>
                            <div class="label">Credits Left</div>
                        </div>
                        <div class="stat-box">
                            <div class="value" id="stat-jobs">0</div>
                            <div class="label">Total Jobs</div>
                        </div>
                    </div>
                    <h2 style="margin-top:20px">Recent Jobs</h2>
                    <table id="recent-jobs-table">
                        <thead><tr><th>Status</th><th>Results</th><th>Credits</th><th>Date</th></tr></thead>
                        <tbody id="recent-jobs-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Jobs Tab -->
        <div id="tab-jobs" class="tab-content">
            <div class="card full-width">
                <h2>Scrape Jobs</h2>
                <table>
                    <thead><tr><th>ID</th><th>Status</th><th>Results</th><th>Credits</th><th>Created</th><th>Actions</th></tr></thead>
                    <tbody id="jobs-body"></tbody>
                </table>
            </div>
            <div class="card full-width hidden" id="job-detail-card" style="margin-top:24px">
                <div style="display:flex;justify-content:space-between;align-items:center">
                    <h2>Job Results</h2>
                    <div class="export-btns">
                        <button class="btn btn-sm btn-outline" onclick="exportJob('json')">JSON</button>
                        <button class="btn btn-sm btn-outline" onclick="exportJob('csv')">CSV</button>
                        <button class="btn btn-sm btn-outline" onclick="exportJob('xlsx')">Excel</button>
                        <button class="btn btn-sm btn-success" onclick="exportJob('hubspot')">HubSpot</button>
                        <button class="btn btn-sm btn-success" onclick="exportJob('salesforce')">Salesforce</button>
                    </div>
                </div>
                <table style="margin-top:16px">
                    <thead><tr><th>Name</th><th>Category</th><th>Rating</th><th>Phone</th><th>Website</th><th>Address</th></tr></thead>
                    <tbody id="results-body"></tbody>
                </table>
            </div>
        </div>

        <!-- Credits Tab -->
        <div id="tab-credits" class="tab-content">
            <div class="grid">
                <div class="card">
                    <h2>Credit Balance</h2>
                    <div class="stats">
                        <div class="stat-box">
                            <div class="value" id="credit-balance">0</div>
                            <div class="label">Available Credits</div>
                        </div>
                        <div class="stat-box">
                            <div class="value" id="credit-used">0</div>
                            <div class="label">Total Used</div>
                        </div>
                    </div>
                    <p style="color:#888;font-size:13px;margin-top:12px">
                        1 credit = 1 place scraped. Reviews and opening hours are included at no extra cost.
                    </p>
                </div>
                <div class="card">
                    <h2>Add Credits</h2>
                    <div class="form-group">
                        <label>Amount</label>
                        <input type="number" id="add-credits-amount" min="1" value="100" placeholder="100">
                    </div>
                    <button class="btn btn-primary" onclick="addCredits()">Add Credits</button>
                    <p style="color:#888;font-size:12px;margin-top:12px">
                        Stripe payment integration coming soon. Manual top-up for now.
                    </p>
                </div>
            </div>
            <div class="card full-width" style="margin-top:24px">
                <h2>Transaction History</h2>
                <table>
                    <thead><tr><th>Date</th><th>Type</th><th>Amount</th><th>Description</th></tr></thead>
                    <tbody id="transactions-body"></tbody>
                </table>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="tab-settings" class="tab-content">
            <div class="grid">
                <div class="card">
                    <h2>API Keys</h2>
                    <p style="font-size:13px;color:#666;margin-bottom:16px">
                        Use API keys to access the scraper programmatically via the REST API.
                    </p>
                    <div id="api-keys-list"></div>
                    <div style="margin-top:16px;display:flex;gap:8px">
                        <input type="text" id="new-key-name" placeholder="Key name" style="flex:1;padding:8px 12px;border:1px solid #ddd;border-radius:6px;">
                        <button class="btn btn-primary btn-sm" onclick="createApiKey()">Generate Key</button>
                    </div>
                </div>
                <div class="card">
                    <h2>Webhooks</h2>
                    <p style="font-size:13px;color:#666;margin-bottom:16px">
                        Get notified when scrape jobs complete.
                    </p>
                    <div id="webhooks-list"></div>
                    <div style="margin-top:16px">
                        <div class="form-group">
                            <input type="url" id="new-webhook-url" placeholder="https://your-server.com/webhook" style="width:100%">
                        </div>
                        <button class="btn btn-primary btn-sm" onclick="createWebhook()">Add Webhook</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// State
let token = localStorage.getItem('ms_token');
let currentUser = null;
let selectedJobId = null;
let pollInterval = null;

const API = '';

async function api(path, opts = {}) {
    const headers = { 'Content-Type': 'application/json', ...(opts.headers || {}) };
    if (token) headers['Authorization'] = `Bearer ${token}`;
    const res = await fetch(`${API}${path}`, { ...opts, headers });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || data.message || 'Request failed');
    return data;
}

// Auth
function showAuthTab(tab) {
    document.querySelectorAll('.auth-tabs button').forEach(b => b.classList.remove('active'));
    document.querySelector(`.auth-tabs button:${tab === 'login' ? 'first' : 'last'}-child`).classList.add('active');
    document.getElementById('login-form').classList.toggle('hidden', tab !== 'login');
    document.getElementById('register-form').classList.toggle('hidden', tab !== 'register');
}

async function handleLogin(e) {
    e.preventDefault();
    try {
        const data = await api('/auth/login', {
            method: 'POST',
            body: JSON.stringify({
                email: document.getElementById('login-email').value,
                password: document.getElementById('login-password').value,
            }),
        });
        token = data.token;
        localStorage.setItem('ms_token', token);
        currentUser = data.user;
        showDashboard();
    } catch (err) {
        document.getElementById('auth-error').innerHTML = `<div class="alert alert-error">${err.message}</div>`;
    }
}

async function handleRegister(e) {
    e.preventDefault();
    try {
        const data = await api('/auth/register', {
            method: 'POST',
            body: JSON.stringify({
                name: document.getElementById('register-name').value,
                email: document.getElementById('register-email').value,
                password: document.getElementById('register-password').value,
            }),
        });
        token = data.token;
        localStorage.setItem('ms_token', token);
        currentUser = data.user;
        showDashboard();
        alert(`Your API key: ${data.apiKey}\n\nSave this! You can find it in Settings.`);
    } catch (err) {
        document.getElementById('auth-error').innerHTML = `<div class="alert alert-error">${err.message}</div>`;
    }
}

function logout() {
    token = null;
    currentUser = null;
    localStorage.removeItem('ms_token');
    if (pollInterval) clearInterval(pollInterval);
    document.getElementById('auth-screen').classList.remove('hidden');
    document.getElementById('dashboard-screen').classList.add('hidden');
}

// Dashboard
async function showDashboard() {
    document.getElementById('auth-screen').classList.add('hidden');
    document.getElementById('dashboard-screen').classList.remove('hidden');
    try {
        const data = await api('/auth/me');
        currentUser = data.user;
        document.getElementById('user-email').textContent = currentUser.email;
        updateCredits(currentUser.credits);
        document.getElementById('stat-jobs').textContent = data.totalJobs;
        loadJobs();
    } catch {
        logout();
    }
}

function updateCredits(amount) {
    document.getElementById('credits-display').textContent = `${amount} credits`;
    document.getElementById('stat-credits').textContent = amount;
}

function showTab(tab) {
    document.querySelectorAll('.nav-tabs button').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById(`tab-${tab}`).classList.add('active');

    if (tab === 'jobs') loadJobs();
    if (tab === 'credits') loadCredits();
    if (tab === 'settings') { loadApiKeys(); loadWebhooks(); }
}

// Scraping
async function startScrape(e) {
    e.preventDefault();
    const btn = document.getElementById('scrape-btn');
    btn.disabled = true;
    btn.textContent = 'Starting...';
    document.getElementById('scrape-error').innerHTML = '';

    try {
        const terms = document.getElementById('search-terms').value.split(',').map(s => s.trim()).filter(Boolean);
        const minRating = document.getElementById('search-min-rating').value;
        const body = {
            searchTerms: terms,
            location: document.getElementById('search-location').value,
            maxResults: parseInt(document.getElementById('search-max').value),
            language: document.getElementById('search-lang').value,
            scrapeReviews: document.getElementById('search-reviews').checked,
            reviewsLimit: parseInt(document.getElementById('search-reviews-limit').value),
            scrapeOpeningHours: document.getElementById('search-hours').checked,
        };
        if (minRating) body.minRating = parseFloat(minRating);

        const data = await api('/scrape', { method: 'POST', body: JSON.stringify(body) });
        updateCredits(data.credits);
        document.getElementById('scrape-error').innerHTML =
            `<div class="alert alert-success">Job ${data.jobId.slice(0,8)}... queued! Check "My Jobs" tab.</div>`;

        // Start polling
        selectedJobId = data.jobId;
        startPolling();
    } catch (err) {
        document.getElementById('scrape-error').innerHTML = `<div class="alert alert-error">${err.message}</div>`;
    } finally {
        btn.disabled = false;
        btn.textContent = 'Start Scraping';
    }
}

function startPolling() {
    if (pollInterval) clearInterval(pollInterval);
    pollInterval = setInterval(async () => {
        try {
            await loadJobs();
            if (selectedJobId) {
                const data = await api(`/scrape/jobs/${selectedJobId}`);
                if (data.status === 'completed' || data.status === 'failed') {
                    clearInterval(pollInterval);
                    pollInterval = null;
                    // Refresh credits
                    const me = await api('/auth/me');
                    updateCredits(me.user.credits);
                }
            }
        } catch {}
    }, 3000);
}

// Jobs
async function loadJobs() {
    try {
        const data = await api('/scrape/jobs?limit=50');
        const tbody = document.getElementById('jobs-body');
        const recentBody = document.getElementById('recent-jobs-body');

        tbody.innerHTML = data.jobs.map(j => `
            <tr>
                <td class="monospace">${j.id.slice(0,8)}...</td>
                <td><span class="badge badge-${j.status}">${j.status}</span></td>
                <td>${j.result_count}</td>
                <td>${j.credits_used}</td>
                <td>${new Date(j.created_at).toLocaleDateString()}</td>
                <td>${j.status === 'completed' ? `<button class="btn btn-sm btn-outline" onclick="viewJob('${j.id}')">View</button>` : ''}</td>
            </tr>
        `).join('');

        recentBody.innerHTML = data.jobs.slice(0, 5).map(j => `
            <tr>
                <td><span class="badge badge-${j.status}">${j.status}</span></td>
                <td>${j.result_count}</td>
                <td>${j.credits_used}</td>
                <td>${new Date(j.created_at).toLocaleDateString()}</td>
            </tr>
        `).join('');
    } catch {}
}

async function viewJob(jobId) {
    selectedJobId = jobId;
    try {
        const data = await api(`/scrape/jobs/${jobId}`);
        const card = document.getElementById('job-detail-card');
        card.classList.remove('hidden');
        const tbody = document.getElementById('results-body');

        tbody.innerHTML = data.results.map(r => `
            <tr>
                <td><strong>${esc(r.placeName || '')}</strong></td>
                <td>${esc(r.category || '')}</td>
                <td>${r.totalReviewScore ? `${r.totalReviewScore} (${r.reviewCount})` : '-'}</td>
                <td>${esc(r.phoneNumber || '')}</td>
                <td>${r.website ? `<a href="${esc(r.website)}" target="_blank">${esc(safeHost(r.website))}</a>` : '-'}</td>
                <td>${esc(r.address?.fullAddress || r.address?.city || '')}</td>
            </tr>
        `).join('');

        card.scrollIntoView({ behavior: 'smooth' });
    } catch (err) {
        alert('Failed to load job: ' + err.message);
    }
}

async function exportJob(format) {
    if (!selectedJobId) return;
    const url = `${API}/scrape/jobs/${selectedJobId}/export/${format}`;
    const res = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
    if (!res.ok) { alert('Export failed'); return; }
    const blob = await res.blob();
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    const ext = format === 'hubspot' || format === 'salesforce' ? 'csv' : format;
    a.download = `${format}_results.${ext}`;
    a.click();
}

// Credits
async function loadCredits() {
    try {
        const data = await api('/credits');
        document.getElementById('credit-balance').textContent = data.credits;
        document.getElementById('credit-used').textContent = data.totalUsed;
        updateCredits(data.credits);

        document.getElementById('transactions-body').innerHTML = data.transactions.map(t => `
            <tr>
                <td>${new Date(t.created_at).toLocaleString()}</td>
                <td>${t.type}</td>
                <td style="color:${t.amount < 0 ? '#dc3545' : '#28a745'};font-weight:600">${t.amount > 0 ? '+' : ''}${t.amount}</td>
                <td>${esc(t.description || '')}</td>
            </tr>
        `).join('');
    } catch {}
}

async function addCredits() {
    const amount = parseInt(document.getElementById('add-credits-amount').value);
    if (!amount || amount <= 0) { alert('Enter a valid amount'); return; }
    try {
        const data = await api('/credits/add', {
            method: 'POST',
            body: JSON.stringify({ amount }),
        });
        updateCredits(data.credits);
        loadCredits();
        alert(`Added ${amount} credits. New balance: ${data.credits}`);
    } catch (err) {
        alert('Failed: ' + err.message);
    }
}

// API Keys
async function loadApiKeys() {
    try {
        const data = await api('/auth/me');
        document.getElementById('api-keys-list').innerHTML = data.apiKeys.map(k => `
            <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #eee">
                <div>
                    <strong>${esc(k.name)}</strong>
                    <div class="api-key-display" style="margin-top:4px">${k.key}</div>
                </div>
                <button class="btn btn-sm btn-danger" onclick="deleteApiKey(${k.id})">Revoke</button>
            </div>
        `).join('');
    } catch {}
}

async function createApiKey() {
    const name = document.getElementById('new-key-name').value || 'API Key';
    try {
        const data = await api('/auth/api-keys', {
            method: 'POST',
            body: JSON.stringify({ name }),
        });
        alert(`New API key: ${data.key}`);
        loadApiKeys();
    } catch (err) {
        alert('Failed: ' + err.message);
    }
}

async function deleteApiKey(id) {
    if (!confirm('Revoke this API key?')) return;
    try {
        await api(`/auth/api-keys/${id}`, { method: 'DELETE' });
        loadApiKeys();
    } catch (err) {
        alert('Failed: ' + err.message);
    }
}

// Webhooks
async function loadWebhooks() {
    try {
        const data = await api('/webhooks');
        document.getElementById('webhooks-list').innerHTML = data.webhooks.length
            ? data.webhooks.map(w => `
                <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #eee">
                    <div>
                        <div class="monospace" style="font-size:13px">${esc(w.url)}</div>
                        <div style="font-size:11px;color:#888">Events: ${w.events.join(', ')}</div>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="deleteWebhook(${w.id})">Remove</button>
                </div>
            `).join('')
            : '<p style="color:#888;font-size:13px">No webhooks configured.</p>';
    } catch {}
}

async function createWebhook() {
    const url = document.getElementById('new-webhook-url').value;
    if (!url) { alert('Enter a webhook URL'); return; }
    try {
        await api('/webhooks', {
            method: 'POST',
            body: JSON.stringify({ url, events: ['job.completed', 'job.failed'] }),
        });
        document.getElementById('new-webhook-url').value = '';
        loadWebhooks();
    } catch (err) {
        alert('Failed: ' + err.message);
    }
}

async function deleteWebhook(id) {
    if (!confirm('Remove this webhook?')) return;
    try {
        await api(`/webhooks/${id}`, { method: 'DELETE' });
        loadWebhooks();
    } catch (err) {
        alert('Failed: ' + err.message);
    }
}

// Helpers
function esc(s) {
    const d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML;
}

function safeHost(url) {
    try { return new URL(url).hostname; } catch { return url; }
}

// Init
if (token) {
    showDashboard();
}
</script>
</body>
</html>
